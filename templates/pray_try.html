<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>抽籤與解籤 - 廟宇靈</title>
    <!-- 引入 Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <main class="container my-5">
        <section class="extra">
            <h2 class="text-center mb-4">詢問神明</h2>
            <div class="mb-3">
                <input type="text" id="userQuestion" class="form-control" placeholder="請輸入您的問題" oninput="checkInput()">
            </div>
            <div class="button-group d-flex justify-content-center gap-3 mb-4">
                <button id="drawBtn" class="btn btn-primary" disabled>抽籤</button>
                <button id="throwBtn" class="btn btn-primary" disabled>擲杯</button>
                <button id="interpretBtn" class="btn btn-primary" disabled>解籤</button>
            </div>
            <h2 class="text-center mb-4">結果</h2>
            <div id="result" class="result-container"></div>
        </section>
    </main>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        document.addEventListener("DOMContentLoaded", function() {
            document.getElementById("drawBtn").addEventListener("click", startDraw);
            document.getElementById("throwBtn").addEventListener("click", startThrow);
            document.getElementById("interpretBtn").addEventListener("click", interpretLottery);
            checkInput();
        });

        function checkInput() {
            const question = document.getElementById("userQuestion").value.trim();
            document.getElementById("drawBtn").disabled = question === "";
        }

        function startDraw() {
            const question = document.getElementById("userQuestion").value.trim();
            if (question === "") {
                document.getElementById("result").innerText = "請先輸入您的問題！";
                return;
            }
            document.getElementById("result").innerText = "抽籤中...";
            fetch("/draw_lottery", { method: "POST" })
                .then(response => response.json())
                .then(data => {
                    if (data.status === "success") {
                        document.getElementById("result").innerText = `抽到籤:\n` + data.poem;
                        document.getElementById("drawBtn").disabled = true;
                        document.getElementById("throwBtn").disabled = false;
                        document.getElementById("interpretBtn").disabled = true;
                    }
                })
                .catch(error => console.error("抽籤錯誤:", error));
        }

        function startThrow() {
            document.getElementById("result").innerText = "擲杯中...";
            document.getElementById("throwBtn").disabled = true;
            fetch("/start_throw", { method: "POST" })
                .then(response => response.json())
                .then(data => {
                    if (data.status === "PENDING") {
                        document.getElementById("result").innerText = 
                            `本次結果：${data.result}（請繼續擲杯）\n目前累計聖杯${data.sacred_count}次`;
                        document.getElementById("throwBtn").disabled = false;
                    } else if (data.status === "DONE") {
                        document.getElementById("result").innerText = data.result;
                        document.getElementById("throwBtn").disabled = true;
                        document.getElementById("interpretBtn").disabled = false;
                    } else if (data.status === "FAILED") {
                        document.getElementById("result").innerText = data.result;
                        document.getElementById("drawBtn").disabled = false;
                        document.getElementById("throwBtn").disabled = true;
                        document.getElementById("interpretBtn").disabled = true;
                    }
                })
                .catch(error => console.error("擲杯錯誤:", error));
        }

        function interpretLottery() {
            document.getElementById("result").innerText = "解籤中...";
            const question = document.getElementById("userQuestion").value;
            fetch("/interpret_lottery", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ question: question })
            })
                .then(response => response.json())
                .then(data => {
                    document.getElementById("result").innerHTML = `
                        <div class="card">
                            <img src="/static/poem_img/poem_${data.id}.png" alt="籤詩圖片" class="card-img-top poem-image">
                            <div class="card-body">
                                <h3 class="card-title">籤詩</h3>
                                <p class="card-text">${data.poem}</p>
                                <h3 class="card-title">解籤</h3>
                                <p class="card-text">${data.interpretation}</p>
                            </div>
                        </div>
                    `;
                    document.getElementById("drawBtn").disabled = false;
                    document.getElementById("throwBtn").disabled = true;
                    document.getElementById("interpretBtn").disabled = true;
                })
                .catch(error => console.error("解籤錯誤:", error));
        }
    </script>
</body>
</html>
